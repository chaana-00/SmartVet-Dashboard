<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Farm History | VetSmart</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Boxicons -->
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
</head>

<body>

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="toggle-btn" id="toggle-btn">
            <i class='bx bx-chevron-right'></i>
        </div>

        <div class="logo">
            <img src="images/FCL.gif" alt="VetSmart Logo" style="width: 100px; height: auto;">
        </div>

        <h2 class="logo">VetSmart</h2>

        <ul>
            <li><a href="add-farm-records.html" class="highlight">
                    <i class='bx bx-file'></i><span class="link-text">Add Farm Records</span>
                </a></li>
            <li><a href="create-prescription.html" class="button">
                    <i class='bx bx-file'></i><span class="link-text">Create Prescription</span>
                </a></li>
            <li><a href="add-batch-details.html"><i class='bx bx-card'></i><span class="link-text">Add Batch
                        Details</span></a></li>
            <li><a href="view-batch-details.html" class="active"><i class='bx bx-folder-open'></i><span
                        class="link-text">View Batch Details</span></a></li>
            <li><a href="view-batch-details.html" class="active"><i class='bx bx-folder-open'></i><span
                        class="link-text">View Batch Details</span></a></li>
            <li><a href="farm-register.html"><i class='bx bx-user'></i><span class="link-text">Farm Register</span></a>
            </li>
            <!-- <li><a href="add-farm-records.html"><i class='bx bx-file'></i><span class="link-text">Add Farm
                        Records</span></a></li> -->
            <li><a href="view-history.html"><i class='bx bx-folder-open'></i><span class="link-text">View
                        History</span></a></li>
            <li><a href="notifications.html" class="active"><i class='bx bx-bell'></i><span
                        class="link-text">Notifications</span></a></li>
            <!-- <li><a href="#"><i class='bx bx-bell'></i><span class="link-text">Notification</span></a></li>
            <li><a href="#"><i class='bx bx-cog'></i><span class="link-text">Settings</span></a></li> -->
            <li><a href="user-dashboard.html"><i class='bx bx-layer'></i><span class="link-text">Dashboard</span></a>
            </li>
        </ul>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main">
        <div class="container mt-4">
            <div class="card shadow-sm p-4">

                <h3 class="mb-4">View Registered Farm History</h3>

                <!-- Dropdown -->
                <div class="mb-3">
                    <label class="form-label">Select Farm ID</label>
                    <select id="farmIdDropdown" class="form-select">
                        <option value="">-- Select Farm ID --</option>
                    </select>
                </div>

                <button class="btn btn-primary mb-3" onclick="searchFarm()">Search</button>

                <div id="message" class="text-danger fw-bold"></div>

                <!-- Table -->
                <div class="table-responsive mt-4">
                    <table id="resultTable" class="table table-bordered table-striped" style="display:none;">
                        <thead class="table-primary">
                            <tr>
                                <th>Farm Name</th>
                                <th>Farm ID</th>
                                <th>Location</th>
                                <th>Contact 1</th>
                                <th>Contact 2</th>
                                <th>Contact 3</th>
                                <th>Owner Name</th>
                                <th>Owner Contact 1</th>
                                <th>Owner Contact 2</th>
                                <th>Farm Type</th>
                                <th>Capacity</th>
                                <th>Note</th>
                            </tr>
                        </thead>
                        <tbody id="farmData"></tbody>
                    </table>
                </div>

                

                <form action="download-all-farms.php" method="post">
                    <button type="submit"
                        style="background:#007bff;color:white;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;display:none;">
                        Download All Farm Records
                    </button>

                    <!-- Hidden download button (show after search) -->
                <button id="downloadBtn" class="btn btn-success mt-3" style="display:none;" onclick="downloadWord()">
                    Download as Word Document
                </button>
                </form>


            </div>
        </div>
    </div>

    <!-- External JS Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-docx-js/0.4.1/html-docx.js"></script>

    <!-- Load Farm IDs -->
    <script>
        let lastFarmData = null;

        window.onload = function () {
            fetch("view-farm.php?load_ids=1")
                .then(res => res.json())
                .then(data => {
                    let dropdown = document.getElementById("farmIdDropdown");
                    data.forEach(id => {
                        let opt = document.createElement("option");
                        opt.value = id;
                        opt.textContent = id;
                        dropdown.appendChild(opt);
                    });
                });
        };

        function searchFarm() {
            let farmId = document.getElementById("farmIdDropdown").value;

            if (farmId === "") {
                alert("Please select a farm ID.");
                return;
            }

            fetch("view-farm.php?farm_id=" + farmId)
                .then(res => res.json())
                .then(data => {
                    let table = document.getElementById("resultTable");
                    let tbody = document.getElementById("farmData");
                    let message = document.getElementById("message");
                    let downloadBtn = document.getElementById("downloadBtn");

                    tbody.innerHTML = "";

                    if (data.status === "error") {
                        message.innerHTML = data.message;
                        table.style.display = "none";
                        downloadBtn.style.display = "none";
                    } else {
                        message.innerHTML = "";
                        let farm = data.data;
                        lastFarmData = farm;

                        tbody.innerHTML = `
                            <tr>
                                <td>${farm.farm_name}</td>
                                <td>${farm.farm_id}</td>
                                <td>${farm.farm_location}</td>
                                <td>${farm.farm_contact1}</td>
                                <td>${farm.farm_contact2}</td>
                                <td>${farm.farm_contact3}</td>
                                <td>${farm.owner_name}</td>
                                <td>${farm.owner_contact1}</td>
                                <td>${farm.owner_contact2}</td>
                                <td>${farm.farm_type}</td>
                                <td>${farm.farm_capacity}</td>
                                <td>${farm.note}</td>
                            </tr>
                        `;

                        table.style.display = "table";
                        downloadBtn.style.display = "inline-block";
                    }
                });
        }

        function downloadWord() {

            if (!lastFarmData) {
                alert("Search a farm record first.");
                return;
            }

            let farm = lastFarmData;

            let content = `
                <h2 style="text-align:center;">Farm Registration Details</h2>
                <hr>
                <p><b>Farm Name:</b> ${farm.farm_name}</p>
                <p><b>Farm ID:</b> ${farm.farm_id}</p>
                <p><b>Location:</b> ${farm.farm_location}</p>
                <p><b>Farm Contacts:</b>
                    <br>1) ${farm.farm_contact1}
                    <br>2) ${farm.farm_contact2}
                    <br>3) ${farm.farm_contact3}
                </p>
                <p><b>Owner Name:</b> ${farm.owner_name}</p>
                <p><b>Owner Contacts:</b>
                    <br>1) ${farm.owner_contact1}
                    <br>2) ${farm.owner_contact2}
                </p>
                <p><b>Farm Type:</b> ${farm.farm_type}</p>
                <p><b>Capacity:</b> ${farm.farm_capacity}</p>
                <p><b>Note:</b> ${farm.note}</p>
            `;

            let blob = window.htmlDocx.asBlob(content);
            saveAs(blob, farm.farm_id + "_FarmDetails.docx");
        }
    </script>

</body>

</html>